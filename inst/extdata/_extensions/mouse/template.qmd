---
title: "Mouse instability"
format: html
---

# Setup

```{r}
library(instability)

```


## Settings

```{r}

#fill out these paths

fsa_folder_to_process <- ""
metadata_table <- read.csv("")

#Provide the appropriate metadata below by replacing the placeholders 
## (eg replace metadata$unique_id with the appropriate column in metadata_table giving the unique id), see ?add_metadata for all the metadata info
metadata_table$sample_file_name <- metadata$unique_id
metadata_table$plate_id <- metadata$plate_id
metadata_table$group_id <- metadata$cell_line
metadata_table$metrics_baseline_control <- metadata$metrics_baseline_control_TF
metadata_table$size_standard <- metadata$repeat_positive_control_TF
metadata_table$size_standard_repeat_length <- metadata$repeat_positive_control_length


# for exporting traces we can give the samples a useful identifying name for a subtitle
metadata_table$sample_name <- paste(
  metadata$cell_line, 
  metadata$day,
  metadata$treatment, 
  metadata$genotype, 
  sep = ", ")



```



# Assign Ladders

```{r}
fsa_raw <- read_fsa(list.files(fsa_folder, full.names = TRUE))

ladder_list <- find_ladders(fsa_raw,
                            ladder_sizes = c(50, 75, 100, 139, 150, 160, 200, 250, 300, 340, 350, 400, 450, 490, 500),
                            show_progress_bar = FALSE)
```


# Find peaks

```{r}
peak_list <- find_fragments(ladder_list,
                            min_bp_size = 300
)
```

# Add metadata

```{r}

  metadata_added_list <- add_metadata(
   fragments_list = peak_list,
   metadata_data.frame = metadata_table
 )

```

# Find alleles

```{r}
allele_list <- find_alleles(metadata_added_list)
```

# Find repeats

```{r}
repeats_list <- call_repeats(
  fragments_list = allele_list,
  force_whole_repeat_units = TRUE,
  repeat_length_correction = "from_metadata"
)

```


# Calculate instability metrics

```{r}
metrics_ungrouped_df <- calculate_instability_metrics(
  fragments_list = repeats_list,
  grouped = FALSE,
  peak_threshold = 0.05
)
```


```{r}
metrics_grouped_df <- calculate_instability_metrics(
  fragments_list = repeats_list,
  grouped = TRUE,
  peak_threshold = 0.05
)
```



# save outputs

## Create Output Folders

creates separate output folders for the different plate ids

```{r}

if (!dir.exists("outputs")) {
  dir.create("outputs")
}

plate_id_names <- unique(metadata_table$plate_id)
for (i in seq_along(plate_id_names)) {
  output_folder_path <- paste("outputs/",plate_id_names[i],"_outputs",sep="")
  if (!dir.exists(output_folder_path)) dir.create(output_folder_path)
}

```


## ladders


```{r}

metadata_split <- split(metadata_table, metadata_table$plate_id)

lapply(metadata_split, function(meta){
  output_name_ladders <-paste0("outputs/",unique(meta$plate_id),"_outputs/",
                               unique(meta$plate_id), "_ladders.pdf")
  
  ladder_list_subset <- ladder_list[meta$sample_file_name]

  pdf(output_name_ladders, height = 5, width = 10)
  for (i in seq_along(ladder_list_subset)) {
    
    ladder_list_subset[[i]]$plot_ladder(
      plot_title = paste0(
        ladder_list_subset[[i]]$unique_id, "\n",
        instability:::ladder_rsq_warning_helper(ladder_list_subset[[i]],
                                                rsq_threshold = 0.998)
      )
      #xlim and ylim can be added here
    )
  }
  dev.off()
})



```

## sample traces

This code below adds the "index peak" (see ?calculate_instability_metrics) as a vertical dotted line and adds the modal repeat length as text

```{r}

lapply(metadata_split, function(meta){
  output_name_traces <-paste0("outputs/",unique(meta$plate_id),"_outputs/",
                               unique(meta$plate_id), "_traces.pdf")
  
  repeats_list_subset <- repeats_list[meta$sample_file_name]

  pdf(output_name_traces, height = 5, width = 10)
  for (i in seq_along(repeats_list_subset)) {
    
    sample_name_i <- metadata_table[which(metadata_table$unique_id == repeats_list[[i]]$unique_id), "sample_name"]
    
      repeats_list[[i]]$plot_trace(
        plot_title = paste0(repeats_list[[i]]$unique_id, "\n", sample_name_i),
        #xlim and ylim can be added here
        xlim = c(80, 250)
        )
      abline(v = repeats_list[[i]]$index_repeat, col = "red", lty = 3, lwd = 2)
      text(x=repeats_list[[i]]$allele_1_repeat, 
           y=repeats_list[[i]]$allele_1_height * 1.02, 
           labels=round(repeats_list[[i]]$allele_1_repeat))

  }
  dev.off()
})


```

## processed repeats object as RDS file
This can be useful for downstream aggregation of experiments. For example, we could read in the repeats_list back into R in another script to calculate instability metrics.

```{r}

saveRDS(repeats_list,
        file = "outputs/processed_repeats_list.rds")
```

## instability metrics

```{r}
write.table(metrics_ungrouped_df, "outputs/instability_metrics_ungrouped.txt",
            row.names=FALSE, sep="\t")

write.table(metrics_grouped_df, "outputs/instability_metrics_grouped.txt",
            row.names=FALSE, sep="\t")

```

